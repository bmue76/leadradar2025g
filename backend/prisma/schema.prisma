generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * Enums
 */

enum FormStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum FormFieldType {
  TEXT
  TEXTAREA
  EMAIL
  PHONE
  NUMBER
  SELECT
  MULTISELECT
  CHECKBOX
  RADIO
  DATE
  DATETIME
  TIME
  NOTE
}

enum EventStatus {
  PLANNED
  ACTIVE
  FINISHED
}

// Stripe Subscription Status
enum SubscriptionStatus {
  trialing
  active
  past_due
  canceled
  incomplete
  incomplete_expired
  unpaid
}

/**
 * Core Multi-Tenant Models
 */

model Tenant {
  id   Int    @id @default(autoincrement())
  name String
  slug String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users      User[]
  forms      Form[]
  formFields FormField[]
  leads      Lead[]
  events     Event[]

  // Form-Presets/Vorlagen (Snapshots), tenant-scoped
  formPresets FormPreset[]

  // Preset-Revisions / Historie (defensiv tenant-scoped)
  formPresetRevisions FormPresetRevision[]

  // Stripe-Subscriptions für diesen Tenant
  subscriptions Subscription[]

  // API-Keys für Integrationen / Mobile
  apiKeys ApiKey[]
}

model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?

  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  formsCreated Form[] @relation("FormsCreated")
  formsUpdated Form[] @relation("FormsUpdated")
  leadsCreated Lead[] @relation("LeadsCreated")

  // Audit: wer hat Preset-Revisions erzeugt (optional)
  presetRevisionsCreated FormPresetRevision[] @relation("PresetRevisionsCreated")
}

/**
 * Forms & Leads Core
 */

model Form {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  description String?
  status      FormStatus @default(DRAFT)
  slug        String?
  version     Int        @default(1)

  // JSON-Konfiguration für Form-spezifische Einstellungen (z. B. Kontaktblock-Slot-Mapping)
  config Json?

  createdByUserId Int?
  createdByUser   User? @relation("FormsCreated", fields: [createdByUserId], references: [id])

  updatedByUserId Int?
  updatedByUser   User? @relation("FormsUpdated", fields: [updatedByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fields     FormField[]
  leads      Lead[]
  eventForms EventForm[]

  @@unique([tenantId, slug])
  @@index([tenantId])
}

model FormField {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  formId Int
  form   Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  key         String
  label       String
  type        FormFieldType
  placeholder String?
  helpText    String?
  required    Boolean       @default(false)
  order       Int           @default(0)

  // JSON-Konfiguration für Feld-spezifische Einstellungen
  // z. B. options (für SELECT / MULTISELECT / RADIO), Min-/Max-Länge, etc.
  config Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([formId, key])
  @@index([tenantId])
  @@index([formId])
}

/**
 * Form Presets / Vorlagen (Snapshots)
 */

model FormPreset {
  id Int @id @default(autoincrement())

  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  category    String
  description String?

  snapshotVersion Int  @default(1)
  snapshot        Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // History / Revisionen
  revisions FormPresetRevision[]

  @@index([tenantId])
  @@index([tenantId, category])
}

model FormPresetRevision {
  id Int @id @default(autoincrement())

  // defensiv tenant-scoped (zusätzlich zu preset.tenantId)
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  presetId Int
  preset   FormPreset @relation(fields: [presetId], references: [id], onDelete: Cascade)

  // entspricht "vorheriger" snapshotVersion des Presets
  version  Int
  snapshot Json

  createdAt DateTime @default(now())

  // Audit: wer hat die Revision erstellt (optional)
  createdByUserId Int?
  createdByUser   User? @relation("PresetRevisionsCreated", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@unique([presetId, version])
  @@index([tenantId])
  @@index([presetId])
  @@index([presetId, createdAt])
  @@index([createdByUserId])
}

model Lead {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  formId Int
  form   Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  eventId Int?
  event   Event? @relation(fields: [eventId], references: [id], onDelete: SetNull)

  // Flexible Antworten-Map basierend auf FormField.key
  values Json

  // Quelle der Erfassung, z. B. "mobile-app", "web-form", "import"
  source String?

  createdByUserId Int?
  createdByUser   User? @relation("LeadsCreated", fields: [createdByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([formId])
  @@index([eventId])
  @@index([createdAt])
}

/**
 * Events & Event-Form-Zuordnung
 */

model Event {
  id       Int    @id @default(autoincrement())
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  slug        String
  description String?
  startDate   DateTime
  endDate     DateTime?
  location    String?
  status      EventStatus @default(PLANNED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  eventForms EventForm[]
  leads      Lead[]

  @@unique([tenantId, slug])
  @@index([tenantId])
}

model EventForm {
  id Int @id @default(autoincrement())

  eventId Int
  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  formId Int
  form   Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, formId])
  @@index([eventId])
  @@index([formId])
}

/**
 * Stripe Subscriptions
 */

model Subscription {
  id Int @id @default(autoincrement())

  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Stripe IDs
  stripeCustomerId     String?
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  // Status & Lifecycle
  status             SubscriptionStatus
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAt           DateTime?
  cancelAtPeriodEnd  Boolean            @default(false)
  canceledAt         DateTime?

  // Convenience-Flag, ob das Abo aktuell "zählt"
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

/**
 * API Keys für nicht-interaktive Clients (Mobile / Integrationen)
 */

model ApiKey {
  id Int @id @default(autoincrement())

  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  /// Anzeigename für den Key (z. B. "Mobile App Prod", "Integration XY")
  name String

  /// Hash des API-Keys (z. B. SHA-256)
  keyHash String

  /// Ob der Key aktuell verwendet werden darf
  isActive Boolean @default(true)

  /// Letzte Verwendung des Keys (z. B. für Auditing / Cleanup)
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([keyHash])
}
